#! /usr/bin/env bash

# @file        bin/sort-files
# @author      Brandon Christie <bchristie.dev@gmail.com>

function numberToMonth()
{
  local -n _month=$1
  local -a months=(January February March April May June July August September October November December)

  _month=${month/0/}
  _month=${months[$month-1]}
}

function organize()
{
  local -r dir=$1
  local -r sdir=$2
  local file year month rest

  for file in "$dir"/*; do
    if [[ -d $file ]]; then
      organize "$file" "$sdir"
      continue
    fi

    IFS='-' read -r year month rest <<<"$(stat -c "%w" "$file" | cut -d ' ' -f 1)"
    numberToMonth "month"

    [[ -d "$sdir/$year/$month" ]] || mkdir -p "$sdir/$year/$month"
    cp -- "$file" "$sdir/$year/$month"
  done
}

function main()
{
  local -r dir=${1%\/}
  local -r sdir="${2%\/}"

  if [[ ! -d $dir ]]; then
    echo "$dir is not a directory" >&2
    return 1
  fi

  if [[ -d $sdir ]]; then
    echo "$sdir is already a directory" >&2
    return 1
  fi

  mkdir -- "$sdir"
  organize "$dir" "$sdir"
}

main "$@"
